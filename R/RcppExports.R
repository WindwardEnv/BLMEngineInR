# Generated by using Rcpp::compileAttributes() -> do not edit by hand
# Generator token: 10BE3573-1514-4C36-9D1C-5A225CD40393

#' @title Calculate the Residual
#'
#' @description Calculate the residuals of the speciation problem.
#'
#' @details The residuals of the speciation problem are the calculated total
#'   moles for each component minus their known concentrations. In the case of
#'   a toxicity run (DoTox = TRUE), the residual for the `MetalComp` component
#'   is instead the sum of the `BLMetalSpecs` concentrations minus the
#'   `CATarget`. This, paired with a modified set of derivatives for the
#'   `MetalComp` in the Jacobian matrix, results in Newton-Rapshon changing the
#'   metal concentration in order to produce chemical conditions that would
#'   result in the critical accumulation known to cause a toxic effect.
#'
#' @param NComp integer, the number of components
#' @param NSpec integer, the number of species
#' @param SpecConc numeric vector (NSpec), the concentration of chemical
#'   species
#' @param SpecStoich integer matrix (NSpec x NComp), the stoichiometry of
#'   species formatin reactions
#' @param TotMoles numeric vector (NComp), the total moles of each component
#' @param SpecCtoM numeric vector (NSpec), the concentration-to-mass conversion
#'   factor for each chemical species
#' @param CompName character vector (NComp), the names of the components
#' @param CompType character vector (NComp), the type of component. It should
#'   be a fixed set of values (MassBal, FixedAct, Substituted, ChargeBal,
#'   SurfPot)
#' @param MetalComp integer, the position in component vectors of the toxic
#'   metal component
#' @param BLMetalSpecs integer vector, the position in the species vectors of
#'   the metal-biotic ligand species associated with toxicity
#' @param CATarget numeric, the target critical accumulation value for a
#'   toxicity run, in mol/kg
#' @param DoTox logical, if TRUE = toxicity run, FALSE = speciation run
#'
#' @return A `list` object with the following components:
#' \describe{
#'  \item{\code{MaxError}}{numeric, the highest absolute error fraction in this
#'   iteration =max(abs(Resid / TotMoles))}
#'  \item{\code{WhichMax}}{integer, the position in the component vectors of the
#'    component with the highest absolute error}
#'  \item{\code{Resid}}{numeric vector (NComp), the residuals =
#'    calculated totals - known totals}
#'  \item{\code{CompError}}{numeric vector (NComp), the absolute error fraction
#'    for each component in this iteration =abs(Resid / TotMoles)}
#'  \item{\code{CalcTotConc}}{numeric vector (NComp), the calculated total
#'    concentration of each component = CalcTotMoles / CtoM}
#'  \item{\code{CalcTotMoles}}{numeric vector (NComp), the calculated total
#'    moles of each component = sum(SpecConc * SpecCtoM * SpecStoich[,j]) for
#'    each component j}
#' }
#'
CalcResidual <- function(NComp, NSpec, SpecConc, SpecStoich, TotMoles, SpecCtoM, CompName, CompType, MetalComp, NBLMetal, BLMetalSpecs, CATarget, DoTox) {
    .Call(`_BLMEngineInR_CalcResidual`, NComp, NSpec, SpecConc, SpecStoich, TotMoles, SpecCtoM, CompName, CompType, MetalComp, NBLMetal, BLMetalSpecs, CATarget, DoTox)
}

#' Calculate Species Concentrations
#'
#' Use `CalcSpecConc` to calculate species concentrations from a known set of
#' free component ion concentrations.
#'
#' This is an internal function that will, for each species `i` in `NSpec`
#' calculate the equilibrium concentration, which in its most basic form would
#' be calculated as \eqn{SpecConc_{i} = K_{i} *
#' \prod_{j=1}^{n}(CompConc^SpecStoich_{i,j})}. Further modifications to these
#' calculations would include temperature correction, ionic strength
#' corrections, and diffuse double layer calculations for organic matter
#' binding. As of 19-Oct-2023, none of these corrections have been implemented.
#'
#' This is the C++ version of this function.
#'
#' @param CompConc A vector of component concentrations for each of `NComp` components.
#' @param K A vector of reaction equilibrium constants for each of `NSpec` reactions.
#' @param SpecStoich A matrix of reaction stoichiometry, with `NSpec` rows and `NComp` columns.
#' @param SpecName character vector (NSpec), the names of the chemical species
#' @param NComp The number of components in the equilibrium system.
#' @param NSpec The number of species (reactions) in the equilibrium system.
#'
#' @returns A vector of `NSpec` species concentrations.
#'
#' @noRd
CalcSpecConc <- function(CompConc, SpecK, SpecStoich, SpecName, NComp, NSpec) {
    .Call(`_BLMEngineInR_CalcSpecConc`, CompConc, SpecK, SpecStoich, SpecName, NComp, NSpec)
}

#' Calculate Species Concentrations
#'
#' Use `CalcLogSpecConc` to calculate species concentrations from a known set of
#' free component ion concentrations.
#'
#' This is an internal function that will, for each species `i` in `NSpec`
#' calculate the equilibrium concentration, which in its most basic form would
#' be calculated as \eqn{SpecConc_{i} = K_{i} *
#' \prod_{j=1}^{n}(CompConc^SpecStoich_{i,j})}. Further modifications to these
#' calculations would include temperature correction, ionic strength
#' corrections, and diffuse double layer calculations for organic matter
#' binding. As of 19-Oct-2023, none of these corrections have been implemented.
#'
#' This is the C++ version of this function.
#'
#' @param LogCompConc A vector of log10-transformed component concentrations for each of `NComp` components.
#' @param LogK A vector of log10-transformed reaction equilibrium constants for each of `NSpec` reactions.
#' @param SpecStoich A matrix of reaction stoichiometry, with `NSpec` rows and `NComp` columns.
#' @param SpecName character vector (NSpec), the names of the chemical species
#' @param NComp The number of components in the equilibrium system.
#' @param NSpec The number of species (reactions) in the equilibrium system.
#'
#' @returns A vector of `NSpec` log10-transformed species concentrations.
#'
#' @noRd
CalcLogSpecConc <- function(LogCompConc, SpecLogK, SpecStoich, SpecName, NComp, NSpec) {
    .Call(`_BLMEngineInR_CalcLogSpecConc`, LogCompConc, SpecLogK, SpecStoich, SpecName, NComp, NSpec)
}

#' Calculate the Newton-Raphson step
NULL

CalcStep <- function(JacobianMatrix, Resid, NComp, CompType, CompName) {
    .Call(`_BLMEngineInR_CalcStep`, JacobianMatrix, Resid, NComp, CompType, CompName)
}

#' @title Iterative step improvement in component concentrations
#'
#' @description CompUpdate calculates an iterative improvement on the component
#' concentrations based on the Newton-Raphson solution from the current
#' iteration.
#'
#' @details If the iteration would cause the adjusted component concentrations
#' to be less than zero, then the component concentration is simply divided by
#' 10 for this iteration.
#'
#' @param NComp integer, the number of components
#' @param CompConcStep numeric vector (NComp) of adjustments to the component
#'   concentrations
#' @param CompConc numeric vector (NComp) of component concentrations, input values
#'   are from this iteration
#' @param CompName numeric vector (NComp) with the names of the components
#'
#' @return  numeric cector CompConc (NComp) modified for the next iteration
#'
NULL

CompUpdate <- function(NComp, CompConcStep, CompConc, CompName) {
    .Call(`_BLMEngineInR_CompUpdate`, NComp, CompConcStep, CompConc, CompName)
}

#' @title Calculate the Jacobian matrix
#' @description Calculate the Jacobian matrix of the speciation problem
#'
#' @details This function calculates the Jacobian matrix of the speciation
#'   problem. The Jacobian matrix is an (`NComp` x `NComp`) matrix of
#'   derivatives, where each row gives the derivative of the residual each total
#'   component concentration, dR[i], with respect to, in each column, the
#'   component free concentration, dX[j]. (i.e., \eqn{Z_{i,j} = \delta Resid_{i}
#'   / \delta CompConc_{j}}).
#'
#' @param NComp integer, the number of components
#' @param NSpec integer, the number of species
#' @param SpecStoich integer matrix (NSpec x NComp), the stoichiometry of
#'   each reaction
#' @param SpecConc numeric vector (NSpec), the concentrations of each species
#' @param SpecCtoM numeric vector (NSpec), the factor to apply to
#'   concentrations (i.e., units of mol/L or mol/kg) to convert to masses (i.e.,
#'   units of mol).
#' @param SpecName character vector (NSpec), the species names
#' @param MetalComp integer, the position in component vectors of the toxic
#'   metal component
#' @param BLMetalSpecs integer vector, the position in the species vectors of
#'   the metal-biotic ligand species associated with toxicity
#' @param DoTox logical, if TRUE = toxicity run, FALSE = speciation run
#'
#' @return numeric matrix (NComp x NComp), the jacobian matrix (see details)
#' @keywords internal
NULL

Jacobian <- function(NComp, NSpec, SpecStoich, SpecConc, SpecCtoM, CompName, MetalComp, NBLMetal, BLMetalSpecs, DoTox) {
    .Call(`_BLMEngineInR_Jacobian`, NComp, NSpec, SpecStoich, SpecConc, SpecCtoM, CompName, MetalComp, NBLMetal, BLMetalSpecs, DoTox)
}

