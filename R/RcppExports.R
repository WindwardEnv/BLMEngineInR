# Generated by using Rcpp::compileAttributes() -> do not edit by hand
# Generator token: 10BE3573-1514-4C36-9D1C-5A225CD40393

#' @title CHemical Equilibria in Soils and Solutions
#'
#' @description Given a chemical system, equilibria equations, and total
#'   concentrations of components, calculate the species concentrations of each
#'   chemical product in the system.
#'
#' @param QuietFlag character, one of "Very Quiet" (only print out when run is
#'   done), "Quiet" (print out Obs=iObs), or "Debug" (print out lots of info)
#' @param ConvergenceCriteria numeric, the maximum value of MaxError that 
#'   counts as convergence by the Newton-Raphson root-finding algorithm
#' @param MaxIter integer, the maximum number of iterations the Newton-Raphson
#'   root-finding algorithm should do before giving up
#' @param NComp integer, number of components
#' @param NSpec integer, number of species reactions
#' @param NBLMetal integer, the number of biotic ligand-bound metal species 
#'   that are associated with toxic effects.
#' @param SpecK numeric vector (NSpec), the equilibrium coefficient of the
#'   formation reactions
#' @param SpecStoich signed integer matrix (NSpec x NComp), the reaction
#'   stoichiometry of the formation reactions
#' @param SpecCtoM numeric vector (NSpec), the concentration to mass conversion
#'   factor of the chemical species for which we have formation reactions
#' @param SpecName character vector (NSpec), the name of the chemical species
#'   for which we have formation reactions
#' @param CompType character vector (NComp), the type of each component in the
#'   simulation
#' @param CompName character vector (NComp), the name of each component in the
#'   simulation
#' @param TotMoles numeric vector (NComp), the total moles of each component in
#'   the simulation (units of mol)
#' @param TotConc numeric vector (NComp), the total concentrations of each
#'   component in the simulation (units of e.g., mol/L and mol/kg)
#' @param DoTox logical, TRUE for toxicity mode where the MetalName component
#'   concentration is adjusted to try to match the CATarget with BLMetalSpecs
#' @param MetalName character string, the name of the toxic metal
#' @param MetalComp integer, the position of the metal in the component arrays
#'   (i.e., which is the toxic metal component) Note: this are base-1 indexed.
#' @param BLMetalSpecs integer vector, the positions of the species in the
#'   arrays which contribute to toxicity (i.e., which species are the toxic
#'   metal bound to the relevant biotic ligand) Note: these are base-1 indexed.
#' @param CATarget numeric, the target critical accumulation in units of mol /
#'   kg (only used when DoTox == TRUE)
#'
#' @return list with the following elements:
#'   \describe{
#'     \item{SpecConc}{numeric vector (NSpec), the concentrations of each
#'       species for which we have formation reactions}
#'     \item{Iter}{integer, the number of Newton-Raphson iterations that we
#'       needed to reach convergence}
#'     \item{MaxError}{numeric, the highest final absolute error fraction
#'       =max(abs(Resid / TotMoles))}
#'     \item{CalcTotConc}{numeric vector (NComp), the calculated total
#'       concentrations of each component in the simulation (units of e.g.,
#'       mol/L and mol/kg)}
#'   }
#' @export
#'
CHESS <- function(QuietFlag, ConvergenceCriteria, MaxIter, NComp, NSpec, NBLMetal, SpecK, SpecTemp, SpecDeltaH, SpecStoich, SpecCtoM, SpecName, CompType, CompName, TotConc, SysTemp, DoTox, MetalName, MetalComp, BLMetalSpecs, CATarget) {
    .Call(`_BLMEngineInR_CHESS`, QuietFlag, ConvergenceCriteria, MaxIter, NComp, NSpec, NBLMetal, SpecK, SpecTemp, SpecDeltaH, SpecStoich, SpecCtoM, SpecName, CompType, CompName, TotConc, SysTemp, DoTox, MetalName, MetalComp, BLMetalSpecs, CATarget)
}

#' @title Calculate the Moles and Concentrations For This Iteration
#' 
#' @description Sum the relevant species concentrations to calculate the 
#'   resulting total concentrations and moles for each component.
#'
#' @param NComp integer, the number of components
#' @param NSpec integer, the number of species
#' @param SpecConc numeric vector (NSpec), the concentration of chemical
#'   species
#' @param SpecStoich integer matrix (NSpec x NComp), the stoichiometry of
#'   species formatin reactions
#' @param SpecCtoM numeric vector (NSpec), the concentration-to-mass conversion
#'   factor for each chemical species
#' @param CalcTotConc (return parameter) numeric vector (NComp), the 
#'   calculated total concentration of each component = CalcTotMoles / CtoM
#' @param CalcTotMoles (return parameter) numeric vector (NComp), the 
#'   calculated total moles of each component = sum(SpecConc * SpecCtoM * 
#'   SpecStoich[,j]) for each component j
#' 
#' @return void
#' 
#' @name CalcIterationTotals
#' @usage CalcIterationTotals(NComp, NSpec, SpecConc, SpecCtoM, SpecStoich, 
#'   CalcTotMoles, CalcTotConc);
NULL

#' @title Calculate the Residual - and only the residual
#'
#' @description Calculate the residuals of the speciation problem.
#'
#' @details The residuals of the speciation problem are the calculated total
#'   moles for each component minus their known concentrations. This function
#'   does not account for the different toxic metal residual needed in a 
#'   toxicity run.
#'
#' @param NComp integer, the number of components
#' @param TotMoles numeric vector (NComp), the total moles of each component
#' @param CalcTotMoles numeric vector (NComp), the calculated total moles of 
#'   each component = sum(SpecConc * SpecCtoM * SpecStoich[,j]) for each 
#'   component j
#' @param CompType character vector (NComp), the type of component. It should
#'   be a fixed set of values (MassBal, FixedAct, Substituted, ChargeBal,
#'   SurfPot)
#'
#' @return numeric vector (NComp), the residuals = calculated totals - known 
#'   totals
#' 
#' @name CalcResidualsOnly
#' @usage CalcResidualsOnly(NComp, CalcTotMoles, TotMoles, CompType)
NULL

#' @title Calculate the Resid and CompError
#'
#' @description Calculate the residuals of the speciation problem, and the
#'   component Error.
#'
#' @details The residuals of the speciation problem are the calculated total
#'   moles for each component minus their known concentrations. This function
#'   does not account for the different toxic metal residual needed in a 
#'   toxicity run.
#'
#' @param NComp integer, the number of components
#' @param TotMoles numeric vector (NComp), the total moles of each component
#' @param CalcTotMoles numeric vector (NComp), the calculated total moles of 
#'   each component = sum(SpecConc * SpecCtoM * SpecStoich[,j]) for each 
#'   component j
#' @param CompType character vector (NComp), the type of component. It should
#'   be a fixed set of values (MassBal, FixedAct, Substituted, ChargeBal,
#'   SurfPot)
#' @param Resid (return value) numeric vector (NComp), the residuals = 
#'   calculated totals - known totals
#' @param CompError (return value) numeric vector (NComp), the absolute error
#'   fraction for each component in this iteration = abs(Resid / TotMoles)
#'
#' return void
#'
#' @name CalcResidualAndError
#' @usage CalcResidAndError(NComp, CalcTotMoles, TotMoles, CompType, Resid, CompError);
NULL

#' @title Adjust the residual and error for toxicity mode
#'
#' @description Calculate a new residual and error value for the toxic metal
#'   component, based instead on the difference between the target and 
#'   calculated critical accumulations.
#'
#' @details This should only be run when DoTox = TRUE. The residual for the
#'   `MetalComp` component is instead the sum of the `BLMetalSpecs`
#'   concentrations minus the `CATarget`. This, paired with a modified set of 
#'   derivatives for the `MetalComp` in the Jacobian matrix, results in 
#'   Newton-Rapshon changing the metal concentration in order to produce
#'   chemical conditions that would result in the critical accumulation known
#'   to cause a toxic effect.
#'
#' @param NBLMetal integer, the number of biotic ligand-bound metal species
#' @param SpecConc numeric vector (NSpec), the concentration of chemical
#'   species
#' @param MetalComp integer, the position in component vectors of the toxic
#'   metal component
#' @param BLMetalSpecs integer vector, the position in the species vectors of
#'   the metal-biotic ligand species associated with toxicity
#' @param CATarget numeric, the target critical accumulation value for a
#'   toxicity run, in mol/kg
#' @param Resid (return value) numeric vector (NComp), the residuals =
#'   calculated totals - known totals, modified for toxicity mode upon return
#' @param CompError (return value) numeric vector (NComp), the absolute error
#'   fraction for each component in this iteration =abs(Resid / TotMoles),
#'   modified for toxicity mode upon return
#'
#' @name AdjustForToxMode
#' @usage AdjustForToxMode(NBLMetal, BLMetalSpecs, MetalComp, CATarget, 
#'   SpecConc, Resid, CompError)
NULL

#' @title Find the MaxError and WhichMax
#'
#' @description Determine which component has the maximum absolute error 
#'   fraction.
#'
#' @param NComp integer, the number of components
#' @param CompError numeric vector (NComp), the absolute error fraction for
#'   each component in this iteration =abs(Resid / TotMoles)
#' @param MaxError (return value) numeric, the highest absolute error fraction in this
#'   iteration =max(abs(Resid / TotMoles))
#' @param WhichMax (return value) integer, the position in the component vectors of the
#'    component with the highest absolute error
#' 
#' @return void
#'
#' @name MaxCompError
#' @usage MaxError = MaxCompError(NComp, CompError, WhichMax)
NULL

#' @title Calculate the Residual
#'
#' @description 
#'   Calculate the residuals of the speciation problem - returns a list.
#'
#' @details The residuals of the speciation problem are the calculated total
#'   moles for each component minus their known concentrations. In the case of
#'   a toxicity run (DoTox = TRUE), the residual for the `MetalComp` component
#'   is instead the sum of the `BLMetalSpecs` concentrations minus the
#'   `CATarget`. This, paired with a modified set of derivatives for the
#'   `MetalComp` in the Jacobian matrix, results in Newton-Rapshon changing the
#'   metal concentration in order to produce chemical conditions that would
#'   result in the critical accumulation known to cause a toxic effect.
#'
#' @param NComp integer, the number of components
#' @param NSpec integer, the number of species
#' @param SpecConc numeric vector (NSpec), the concentration of chemical
#'   species
#' @param SpecStoich integer matrix (NSpec x NComp), the stoichiometry of
#'   species formatin reactions
#' @param TotMoles numeric vector (NComp), the total moles of each component
#' @param SpecCtoM numeric vector (NSpec), the concentration-to-mass conversion
#'   factor for each chemical species
#' @param CompName character vector (NComp), the names of the components
#' @param CompType character vector (NComp), the type of component. It should
#'   be a fixed set of values (MassBal, FixedAct, Substituted, ChargeBal,
#'   SurfPot)
#' @param MetalComp integer, the position in component vectors of the toxic
#'   metal component
#' @param BLMetalSpecs integer vector, the position in the species vectors of
#'   the metal-biotic ligand species associated with toxicity
#' @param CATarget numeric, the target critical accumulation value for a
#'   toxicity run, in mol/kg
#' @param DoTox logical, if TRUE = toxicity run, FALSE = speciation run
#'
#' @return A `list` object with the following components:
#' \describe{
#'  \item{\code{MaxError}}{numeric, the highest absolute error fraction in this
#'   iteration =max(abs(Resid / TotMoles))}
#'  \item{\code{WhichMax}}{integer, the position in the component vectors of the
#'    component with the highest absolute error}
#'  \item{\code{Resid}}{numeric vector (NComp), the residuals =
#'    calculated totals - known totals}
#'  \item{\code{CompError}}{numeric vector (NComp), the absolute error fraction
#'    for each component in this iteration =abs(Resid / TotMoles)}
#'  \item{\code{CalcTotConc}}{numeric vector (NComp), the calculated total
#'    concentration of each component = CalcTotMoles / CtoM}
#'  \item{\code{CalcTotMoles}}{numeric vector (NComp), the calculated total
#'    moles of each component = sum(SpecConc * SpecCtoM * SpecStoich[,j]) for
#'    each component j}
#' }
#'
CalcResidualList <- function(NComp, NSpec, SpecConc, SpecStoich, TotMoles, SpecCtoM, CompName, CompType, MetalComp, NBLMetal, BLMetalSpecs, CATarget, DoTox) {
    .Call(`_BLMEngineInR_CalcResidualList`, NComp, NSpec, SpecConc, SpecStoich, TotMoles, SpecCtoM, CompName, CompType, MetalComp, NBLMetal, BLMetalSpecs, CATarget, DoTox)
}

#' Calculate Species Concentrations
#'
#' Use `CalcSpecConc` to calculate species concentrations from a known set of
#' free component ion concentrations.
#'
#' This is an internal function that will, for each species `i` in `NSpec`
#' calculate the equilibrium concentration, which in its most basic form would
#' be calculated as \eqn{SpecConc_{i} = K_{i} *
#' \prod_{j=1}^{n}(CompConc^SpecStoich_{i,j})}. Further modifications to these
#' calculations would include temperature correction, ionic strength
#' corrections, and diffuse double layer calculations for organic matter
#' binding. As of 19-Oct-2023, none of these corrections have been implemented.
#'
#' This is the C++ version of this function.
#'
#' @param CompConc A vector of component concentrations for each of `NComp` components.
#' @param SpecK A vector of reaction equilibrium constants for each of `NSpec` reactions.
#' @param SpecStoich A matrix of reaction stoichiometry, with `NSpec` rows and `NComp` columns.
#' @param SpecName character vector (NSpec), the names of the chemical species
#' @param NComp The number of components in the equilibrium system.
#' @param NSpec The number of species (reactions) in the equilibrium system.
#'
#' @returns A vector of `NSpec` species concentrations.
#'
#' @noRd
CalcSpecConc <- function(CompConc, SpecK, SpecStoich, SpecName, NComp, NSpec) {
    .Call(`_BLMEngineInR_CalcSpecConc`, CompConc, SpecK, SpecStoich, SpecName, NComp, NSpec)
}

#' Calculate Species Concentrations
#'
#' Use `CalcLogSpecConc` to calculate species concentrations from a known set of
#' free component ion concentrations.
#'
#' This is an internal function that will, for each species `i` in `NSpec`
#' calculate the equilibrium concentration, which in its most basic form would
#' be calculated as \eqn{SpecConc_{i} = K_{i} *
#' \prod_{j=1}^{n}(CompConc^SpecStoich_{i,j})}. Further modifications to these
#' calculations would include temperature correction, ionic strength
#' corrections, and diffuse double layer calculations for organic matter
#' binding. As of 19-Oct-2023, none of these corrections have been implemented.
#'
#' This is the C++ version of this function.
#'
#' @param LogCompConc A vector of log10-transformed component concentrations for each of `NComp` components.
#' @param LogK A vector of log10-transformed reaction equilibrium constants for each of `NSpec` reactions.
#' @param SpecStoich A matrix of reaction stoichiometry, with `NSpec` rows and `NComp` columns.
#' @param SpecName character vector (NSpec), the names of the chemical species
#' @param NComp The number of components in the equilibrium system.
#' @param NSpec The number of species (reactions) in the equilibrium system.
#'
#' @returns A vector of `NSpec` log10-transformed species concentrations.
#'
#' @noRd
CalcLogSpecConc <- function(LogCompConc, SpecLogK, SpecStoich, SpecName, NComp, NSpec) {
    .Call(`_BLMEngineInR_CalcLogSpecConc`, LogCompConc, SpecLogK, SpecStoich, SpecName, NComp, NSpec)
}

#' @title Calculate the Newton-Raphson step
#'
#' @param JacobianMatrix numeric matrix (NComp x NComp), the Jacobian matrix
#'   ("Z")
#' @param Resid numeric vector (NComp), the residuals = calculated totals -
#'   known totals
#' @param NComp integer, the number of components
#' @param CompType character vector (NComp), the type of component. It should be
#'   a fixed set of values (MassBal, FixedAct, Substituted, ChargeBal, SurfPot)
#' @param CompName character vector (NComp), the names of the components
#'
#' @return numeric vector (NComp), the N-R step to take for each component ("X"
#'   in C(i+1) = C(i) - X)
#'
CalcStep <- function(JacobianMatrix, Resid, NComp, CompType, CompName) {
    .Call(`_BLMEngineInR_CalcStep`, JacobianMatrix, Resid, NComp, CompType, CompName)
}

#' Set the initial guess for component concentrations
#'
#' The initial guess is calculated by first assuming that component
#' concentrations are equal to the total concentrations.  Then species are
#' calculated based on these components, and the ratio of component totals to
#' actual totals to adjust the estimates of the free component concentrations.
#' Since there are a lot of inter-dependencies between the components, a few
#' iterations are needed to develop good intitial guesses.
#'
#' @param TotConc numeric vector (`NComp`); the total concentrations of components
#' @param CompType character vector (`NComp`); the component type
#' @param SpecK A vector of reaction equilibrium constants for each of `NSpec` reactions.
#' @param SpecStoich A matrix of reaction stoichiometry, with `NSpec` rows and `NComp` columns.
#' @param SpecName character vector (NSpec), the names of the chemical species
#' @param NComp The number of components in the equilibrium system.
#' @param NSpec The number of species (reactions) in the equilibrium system.#' @param NComp integer; the number of components
#'
#' @return CompConc The initial guesses for the free ion concentrations of components
#'
#' @keywords internal
#'
#' @noRd
InitialGuess <- function(TotConc, CompType, SpecK, SpecStoich, SpecName, NComp, NSpec) {
    .Call(`_BLMEngineInR_InitialGuess`, TotConc, CompType, SpecK, SpecStoich, SpecName, NComp, NSpec)
}

#' @title Calculate the Jacobian matrix
#' @description Calculate the Jacobian matrix of the speciation problem
#'
#' @details This function calculates the Jacobian matrix of the speciation
#'   problem. The Jacobian matrix is an (`NComp` x `NComp`) matrix of
#'   derivatives, where each row gives the derivative of the residual each total
#'   component concentration, dR[i], with respect to, in each column, the
#'   component free concentration, dX[j]. (i.e., \eqn{Z_{i,j} = \delta Resid_{i}
#'   / \delta CompConc_{j}}).
#'
#' @param NComp integer, the number of components
#' @param NSpec integer, the number of species
#' @param SpecStoich integer matrix (NSpec x NComp), the stoichiometry of
#'   each reaction
#' @param SpecConc numeric vector (NSpec), the concentrations of each species
#' @param SpecCtoM numeric vector (NSpec), the factor to apply to
#'   concentrations (i.e., units of mol/L or mol/kg) to convert to masses (i.e.,
#'   units of mol).
#' @param SpecName character vector (NSpec), the species names
#' @param MetalComp integer, the position in component vectors of the toxic
#'   metal component
#' @param BLMetalSpecs integer vector, the position in the species vectors of
#'   the metal-biotic ligand species associated with toxicity
#' @param DoTox logical, if TRUE = toxicity run, FALSE = speciation run
#'
#' @return numeric matrix (NComp x NComp), the jacobian matrix (see details)
#' @keywords internal
Jacobian <- function(NComp, NSpec, SpecStoich, SpecConc, SpecCtoM, CompName, MetalComp, NBLMetal, BLMetalSpecs, DoTox) {
    .Call(`_BLMEngineInR_Jacobian`, NComp, NSpec, SpecStoich, SpecConc, SpecCtoM, CompName, MetalComp, NBLMetal, BLMetalSpecs, DoTox)
}

UpdateTotalsList <- function(NComp, NSpec, DoTox, CompType, CompName, MetalName, SpecStoich, SpecMoles, CompCtoM, TotMoles, TotConc) {
    .Call(`_BLMEngineInR_UpdateTotalsList`, NComp, NSpec, DoTox, CompType, CompName, MetalName, SpecStoich, SpecMoles, CompCtoM, TotMoles, TotConc)
}

